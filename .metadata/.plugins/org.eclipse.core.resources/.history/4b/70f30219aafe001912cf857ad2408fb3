package com.example.controller;

import java.security.Principal;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.servlet.ModelAndView;

import com.example.domain.CalenderEvent;
import com.example.mapper.CalenderEventMapper;
import com.example.mapper.PerticipateEventMapper;

@Controller
public class PerticipateController {

	@Autowired
	CalenderEventMapper calenderEventMapper;

	@Autowired
	PerticipateEventMapper perticipateEventMapper;

	@PostMapping("/calender/event_details_join")
	public ModelAndView join(@ModelAttribute("username")String username,
			@ModelAttribute("id")int id, Principal principal,ModelAndView mav) {
		mav.setViewName("/calender/event_details");

		String join = "参加";

	    String findJoin = perticipateEventMapper.findJoin(id,username,join);

	    if(findJoin.equals("参加")) {
	    	mav.addObject("message","参加されています");
	    }else {
	    	perticipateEventMapper.joinSave(id,username,join);
	    }

		Optional<CalenderEvent> eventDetails = calenderEventMapper.findId(id);

		if (principal != null) {

			final String loginUser = principal.getName();
			final String user = eventDetails.get().getName();

			if (loginUser.equals(user) == true) {
				mav.addObject("same", "same");
			}
		}

		mav.addObject("eventDetails", eventDetails.get());

		return mav;
	}

}
