package com.example.controller;

import java.security.Principal;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import com.example.config.RegisterUserService;
import com.example.entity.Account;

@Controller
public class AuthController {

	@Autowired
	RegisterUserService resisterUserService;

	@GetMapping("/")
    public String index(Model model) {

        return "redirect:/";
    }

	@RequestMapping("/")
    public String index(Model mav , Principal principal) {

    	final String user = principal.getName();
    	mav.addAttribute("user" , user);

    	Authentication auth = (Authentication)principal;
        UserDetails userDetails = (UserDetails)auth.getPrincipal();

        mav.addAttribute("userDetails" , userDetails);

        return "index";
    }

    @RequestMapping("/login*")
    public String login(@ModelAttribute("username") String username,Model model) {

        model.addAttribute("username" ,username);
        model.addAttribute("loginError", true);

        return "login";
    }

    @GetMapping("/signup")
    public String signup(Model model) {

        return "signup";
    }

    @PostMapping("/signup")
    public String loginForm(Model model,@ModelAttribute("username") String username, @ModelAttribute("password") String password) throws Exception{

    	Account account = new Account();

		account.setUsername(username);
		account.setPassword(password);

    	String message = resisterUserService.registerUser(account);

    	model.addAttribute("message", message);

    	return "login" ;
    }

}